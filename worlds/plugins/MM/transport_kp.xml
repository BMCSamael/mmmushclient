<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Monday, November 11, 2013, 8:28 PM -->
<!-- MuClient version 4.90 -->

<!-- Plugin "transport_kp" generated by Plugin Wizard -->

<muclient>

<plugin
   name="transport_kp"
   author="Ruthgul"
   id="d75d47db12b5271e7e063d46"
   language="Lua"
   purpose="transportation items keypad"
   save_state="y"
   date_written="2013-11-11 20:28:09"
   date_modified="2014-01-04 18:24:33"
   requires="4.71"
   version="1.0"
   >

<description trim="y">

<![CDATA[

.----------------.
 | transport_kp |
`----------------'

Adds numpad keystrokes to control a transportation item (broom, magic carpet, rocking horse, etc.)


*** REQUIRES ***

- MUSHclient _must_ have write access to its folder.
- accelerators (plugin id="f99134f19ea994a0cc0888d1") must be installed and enabled.
- Client setting: Game, Configure, Output > [x] Convert IAC EOR/GA to new line (must be checked).


Keystokes:

* When you sit on a transportation item, the following keyboard accelerators are enabled:

Numpad7|Numpad8|Numpad9|Numpad6|Numpad3|Numpad2|Numpad1|Numpad4 : say fly northwest|north|northeast|east|southeast|south|southwest|west

Numpad5 : say stop


* When you stand, the above accelerators are DISABLED, and your normal keystrokes are restored.


Author: Ruthgul

Latest version:
http://github.com/MateriaMagicaLLC/mm-mushclient-scripts

]]>

</description>

</plugin>



<!--  Aliases  -->

<aliases>

<!--  Plugin help  -->

  <alias
   script="OnHelp"
   match="^transport\_kp(|( |\:)help)$"
   regexp="y"
   enabled="y"
  >
  </alias>

</aliases>



<!--  Triggers  -->

<triggers>

  <trigger
   enabled="y"
   keep_evaluating="y"
   match="^(You scramble to your feet\.|You are no longer using (?P&lt;item&gt;.+)\.)$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>on_foot("%&lt;item&gt;")
</send>
  </trigger>

  <trigger
   enabled="y"
   keep_evaluating="y"
   match="^You sit(| down) (in|on) (?P&lt;item&gt;.+)\."
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>on_a_transportation_item("%&lt;item&gt;")
</send>
  </trigger>

</triggers>



<!--  Scripts  -->

<script>

<![CDATA[

require "wait"


-----------------
-- plugin stuff
-----------------

function OnPluginInstall()
  wait.make(function()
    Tell("-- " .. GetPluginInfo(GetPluginID (), 1) .. ": type ")
    ColourTell("silver", "black", GetPluginInfo(GetPluginID (), 1) .. " help")
    Note(" to see info about this plugin --")

    transport = false
    backed_up = false

    use_accelerators = is_accelerators_present()

    wait.time(3)
    use_accelerators = is_accelerators_present()

    if (use_accelerators) then
      EnableTriggerGroup("detect_transport", true)
    else
      ColourNote("tomato", "black", "-- transport_kp: the accelerators plugin isn't installed / enabled --")
    end
  end)
end


function OnPluginDisconnect()
  if (use_accelerators) then
    transport = false
    disable_transport_accel()
  end
end


function OnPluginDisable()
  if (use_accelerators) then
    disable_transport_accel()
  end
end


function OnPluginClose()
  if (use_accelerators) then
    disable_transport_accel()
  end
end


function OnPluginListChanged()
  detect_plugins()
end


function detect_plugins()
  use_accelerators = is_accelerators_present()
end


function is_plugin_present(name, id)
  local res = false

  local plugin_name = GetPluginInfo(id, 1)

  if (plugin_name == name) then
    -- is it enabled?
    if (GetPluginInfo(id, 17)) then
      res = true
    end
  end

  return res
end


function OnHelp()
  ColourNote("silver", "black", world.GetPluginInfo(world.GetPluginID(), 3))
  Note("")
  ColourNote("silver", "black", "(this version: " .. os.date("%c", GetPluginInfo(GetPluginID(), 14)) .. ")")
end


function plugin_update_url()
  local t = {
    "https://raw.githubusercontent.com/MateriaMagicaLLC/mm-mushclient-scripts/master/src/transport_kp.xml",
  }
  return (table.concat(t, ";"))
end



-------------------------------------------
-- interface with the accelerators plugin
-------------------------------------------

function is_accelerators_present()
  return is_plugin_present("accelerators", "f99134f19ea994a0cc0888d1")
end


transport_config = {
  ["numpad7"] = "say fly northwest",
  ["numpad8"] = "say fly north",
  ["numpad9"] = "say fly northeast",
  ["numpad6"] = "say fly east",
  ["numpad3"] = "say fly southeast",
  ["numpad2"] = "say fly south",
  ["numpad1"] = "say fly southwest",
  ["numpad4"] = "say fly west",
  ["subtract"] = "say fly up",
  ["add"] = "say fly down",

  ["numpad5"] = "say stop",
  ["numpad0"] = "stand",
}


function enable_transport_accel()
  if (not backed_up) then
    Note("-- transport_kp: enabling transport accelerators --")

    for keystroke, command in pairs(transport_config) do
      backup_keystroke(keystroke)
      add_accelerator(keystroke, command, "yes")
    end

    backed_up = true
  end
end


function disable_transport_accel()
  if (backed_up) then
    Note("-- transport_kp: desabling transport accelerators --")

    for keystroke, _ in pairs(transport_config) do
      restore_keystroke(keystroke, "yes")
    end

    backed_up = false
  end
end


function backup_keystroke(keystroke)
  local res

  res = CallPlugin("f99134f19ea994a0cc0888d1", "backup_accelerator", keystroke)

  return res
end


function restore_keystroke(keystroke, override)
  local res

  res = CallPlugin("f99134f19ea994a0cc0888d1", "restore_accelerator", keystroke, override)

  return res
end


function add_accelerator(keystroke, command, override)
  local res, val

  res, val = CallPlugin("f99134f19ea994a0cc0888d1", "add_accelerator", keystroke, command, override)

  if (res ~= 0) then
    val = false
  end

  return val
end


function del_accelerator(keystroke, override)
  local res, val

  res, val = CallPlugin("f99134f19ea994a0cc0888d1", "del_accelerator", keystroke, override)

  if (res ~= 0) then
    val = false
  end

  return val
end



-----------------------------------
-- sit on transport / stand stuff
-----------------------------------

transportation_items = {
  "a wooden rocking horse",
  "the broom of Baba Yaga",
  "a royal blue Persian carpet",
  "a heavy carpet of flying",
  "a mortar and pestle",
}


function on_foot(item)
  -- after standing from a broom/carpet/rocking horse
  if ((transport) and (item == ""))
  or (find_index(transportation_items, item)) then
    disable_transport_accel()
    transport = false
  end
end


function on_a_transportation_item(item)
  -- sitting on a broom/carpet/rocking horse
  if (find_index(transportation_items, item)) then
    enable_transport_accel()
    transport = true
  end
end


function find_index(t, item)
  local res = nil

  for i = 1, #t do
    if (t[i] == item) then
      res = i
      break
    end
  end

  return res
end


]]>

</script>

</muclient>
