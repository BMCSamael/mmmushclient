<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Tuesday, November 13, 2012, 10:24 AM -->
<!-- MuClient version 4.85 -->

<!-- Plugin "switch_maps" generated by Plugin Wizard -->

<muclient>

<plugin
   name="switch_maps"
   author="Ruthgul"
   id="d54ccc4800e5df1ad0ed0aac"
   language="Lua"
   purpose="switches IMap and the GMCP mapper according to areas"
   date_written="2012-11-13 10:23:36"
   date_modified="2014-11-06 10:30:55"
   requires="4.71"
   version="1.0"
   >

<description trim="y">

<![CDATA[

.---------------.
 | switch_maps |
`---------------'

This plugin is intended for small screens. It helps save screen space, by showing to IMap when you're in the wilds (and hiding the GMCP mapper), and vice versa for non-wilds areas.


** REQUIRES **

- The plugins MM_GMCP_handler (id="f67c4339ed0591a5b010d05b"), IMap_GMCP (id="adc3a873d4e47348da7cb426") and MM_GMCP_Mapper_GMCP (id="f973af093e715dece34dc25f") must be installed and enabled.
- Resize the GMCP mapper's window, if needed, to be the same size as IMap's (400x261), and place it so that it overlaps with it totally.


Author: Ruthgul

Latest version:
http://github.com/MateriaMagicaLLC/mm-mushclient-scripts


]]>

</description>

</plugin>



<!--  Aliases  -->

<aliases>

<!--  Plugin help  -->

   <alias
   enabled="y"
   match="^switch\_maps(|( |\:)help)$"
   regexp="y"
   script="OnHelp"
  >
  </alias>

</aliases>



<!--  Scripts  -->

<script>

<![CDATA[

require "wait"
require "gmcphelper"


-----------------
-- plugin stuff
-----------------

function OnPluginInstall()
  wait.make(function()
    Tell("-- " .. GetPluginInfo(GetPluginID (), 1) .. ": type ")
    ColourTell("silver", "black", GetPluginInfo(GetPluginID (), 1) .. " help")
    Note(" to see info about this plugin --")

    switch_warned = false
    switch_started = false

    -- give the plugins time to initialize
    wait.time(3)
    detect_plugins()
  end)
end


function OnPluginConnect()
  switch_warned = false
  switch_started = false
end


function OnPluginListChanged()
  detect_plugins()
end


function detect_plugins()
  imap_present = imap_plugin_present()
  mapper_present = mapper_plugin_present()
end


function is_plugin_present(name, id)
  local res = false

  local plugin_name = GetPluginInfo(id, 1)

  if (plugin_name == name) then
    -- is it enabled?
    if (GetPluginInfo(id, 17)) then
      res = true
    end
  end

  return res
end


function OnHelp()
  ColourNote("silver", "black", world.GetPluginInfo(world.GetPluginID(), 3))
  Note("")
  ColourNote("silver", "black", "(this version: " .. os.date("%c", GetPluginInfo(GetPluginID(), 14)) .. ")")
end


function plugin_update_url()
  local t = {
    "https://raw.githubusercontent.com/MateriaMagicaLLC/mm-mushclient-scripts/master/src/switch_maps.xml",
  }
  return (table.concat(t, ";"))
end



---------------
-- GMCP stuff
---------------

function OnPluginBroadcast(msg, id, name, text)
  if (id =="f67c4339ed0591a5b010d05b") then -- GMCP message
    if (text == "room.info") then -- room.info
      get_gmcp_room()

      if (not switch_started) then
        start_switching() -- we start on first GMCP room package
      end

      if (switch_started) then
        process_room()
      end
    end
  end
end


function get_gmcp_room()
  local res, gmcparg = CallPlugin("f67c4339ed0591a5b010d05b", "gmcpval", "room.info")
  luastmt = "gmcpdata = " .. gmcparg

  assert(loadstring(luastmt or ""))()
end



----------------
-- switch maps
----------------

function start_switching()
  -- if imap and the GMCP mapper are installed, start the switching script
  -- otherwise, show a warning (once)
  switch_started = (imap_present) and (mapper_present)

  if (not switch_started) and (not switch_warned) then
    switch_warned = true

    if (not imap_present) then
      Note("-- switch_maps - error: IMap_GMCP plugin not installed / enabled --")
    end

    if (not mapper_present) then
      Note("-- switch_maps - error: MM_GMCP_Mapper_GMCP plugin not installed / enabled --")
    end
  end
end


function imap_plugin_present()
  return is_plugin_present("IMap_GMCP", "adc3a873d4e47348da7cb426")
end


function mapper_plugin_present()
  return is_plugin_present("MM_GMCP_Mapper_GMCP", "f973af093e715dece34dc25f")
end


function process_room()
  local area_code = gmcpval("coord.code")

  if (area_code ~= "") then -- vmap room
    mapper_hide()
    imap_show()

  else -- non-vmap room
    imap_hide()
    mapper_show()
  end
end



--------------------------------
-- calls to external functions
--------------------------------

function mapper_show()
  -- calls a function in MM_GMCP_Mapper_GMCP
  local res = CallPlugin("f973af093e715dece34dc25f", "mapper_show")

  return res
end


function mapper_hide()
  -- calls a function in MM_GMCP_Mapper_GMCP
  local res = CallPlugin("f973af093e715dece34dc25f", "mapper_hide")

  return res
end


function imap_show()
  -- calls a function in IMap_GMCP
  local res = CallPlugin("adc3a873d4e47348da7cb426", "imap_show")

  return res
end


function imap_hide()
  -- calls a function in IMap_GMCP
  local res = CallPlugin("adc3a873d4e47348da7cb426", "imap_hide")

  return res
end


]]>

</script>

</muclient>
