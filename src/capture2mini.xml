<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Wednesday, April 03, 2013, 9:19 AM -->
<!-- MuClient version 4.86 -->

<!-- Plugin "capture2mini" generated by Plugin Wizard -->

<muclient>

<plugin
   name="capture2mini"
   author="Ruthgul"
   id="0d02361abda86a9c64488bf3"
   language="Lua"
   purpose="mini-window for channels"
   save_state="y"
   date_written="2013-04-03 09:19:09"
   date_modified="2014-08-16 13:22:52"
   requires="4.71"
   version="1.0"
   >

<description trim="y">

<![CDATA[

.----------------.
 | capture2mini |
`----------------'

Miniwindow for channels captures.


Features:
- It retains the original colors.
- Text in the miniwindow can be (selected and) copied to the clipboard.


** REQUIRES **

- The file generic_miniwindow.lua must be placed in the MUSHclient/lua directory.
- MUSHclient must have write access to its folder.
- capture2dworld (plugin id="b2772cad800b33a6073d9377") must be installed and enabled.


Syntax:

* captures mini [on|off]  - shows/hides the captures miniwindow (beta, on by default)

* captures addblank [on|off]  - adds 1 extra blank line between messages (OFF by default)

* reset captures  - restores the default size

* clear captures mini  - clears the miniwindow contents

(check capture2dworld help for more options)


Plugin created by Ruthgul
Miniwindow code adapted from Fiendish's / Enelya's chat capture plugins

Latest version:
http://github.com/MateriaMagicaLLC/mm-mushclient-scripts


]]>

</description>

</plugin>



<!--  Aliases  -->

<aliases>

  <alias
   match="^captures mini(| (?P&lt;status&gt;(on|off)))$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>toggle_mini_to("%&lt;status&gt;")
</send>
  </alias>

  <alias
   match="^captures addblank(| (?P&lt;status&gt;(on|off)))$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>toggle_blanks_to("%&lt;status&gt;")
</send>
  </alias>

  <alias
    enabled="y"
    regexp="y"
    match="^reset captures$"
    script="restore_defaults"
  >
  </alias>

  <alias
   match="^clear captures mini$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>clear_mini()
</send>
  </alias>


<!--  Plugin help  -->

  <alias
   enabled="y"
   match="^capture2mini(|( |\:)help)$"
   regexp="y"
   script="OnHelp"
  >
  </alias>

</aliases>



<!--  Scripts  -->

<script>

<![CDATA[

require "generic_miniwindow"


-----------------
-- plugin stuff
-----------------

function OnPluginInstall()
  Tell("-- " .. GetPluginInfo(GetPluginID(), 1) .. ": type ")
  ColourTell("silver", "black", GetPluginInfo(GetPluginID(), 1) .. " help")
  Note(" to see info about this plugin --")

  show_mini = ((GetVariable("show_mini") or "true") == "true")
  add_blanks = ((GetVariable("add_blanks") or "false") == "true")

  if (show_mini) then
    do_install_miniwindow("captures", show_mini, true)
  end
end


function OnPluginEnable()
  if (show_mini) then
    mini_show()
  end
end


function OnPluginClose()
  if (show_mini) then
    if GetPluginInfo(GetPluginID(), 17) then -- plugin is enabled
      mini_hide()
    end
  end
end


function OnPluginDisable()
  if (show_mini) then
    mini_hide()
  end
end


function OnPluginSaveState()
  if (show_mini) then
    SetVariable("enabled", tostring(GetPluginInfo(GetPluginID(), 17)))
    save_status()
  end
end


function OnHelp()
  ColourNote("silver", "black", world.GetPluginInfo(world.GetPluginID(), 3))
  Note("")
  ColourNote("silver", "black", "(this version: " .. os.date("%c", GetPluginInfo(GetPluginID(), 14)) .. ")")
end


function plugin_update_url()
  local t = {
    "https://raw.githubusercontent.com/MateriaMagicaLLC/mm-mushclient-scripts/master/src/capture2mini.xml",
  }
  return (table.concat(t, ";"))
end


function plugin_update_aux_url()
  local t = {
    "https://raw.githubusercontent.com/MateriaMagicaLLC/mm-mushclient-scripts/master/src/generic_miniwindow.lua,MUSH/lua",
  }
  return (table.concat(t, ";"))
end



------------
-- toggles
------------

function toggle_mini_to(state)
  show_mini = do_toggle(show_mini, state)

  SetVariable("show_mini", tostring(show_mini))
  SaveState()

  if (show_mini) then
    mini_show()
  else
    mini_hide()
  end
end


function toggle_blanks_to(state)
  add_blanks = do_toggle(add_blanks, state)

  if (add_blanks) then
    ColourNote("dodgerblue", "black", "-- capture2mini: will now add 1 extra blank line between messages --")
  else
    ColourNote("dodgerblue", "black", "-- capture2mini: no longer adding extra blank lines between messages --")
  end

  SetVariable("add_blanks", tostring(add_blanks))
  SaveState()
end


function do_toggle(var, state)
  local res

  if (state == "") then
    res = not var

  elseif (state == "on") then
    res = true

  elseif (state == "off") then
    res = false
  end

  return res
end



----------------------------
-- add stuff to miniwindow
----------------------------

function OnPluginBroadcast(msg, id, name, text)
  if (id == "b2772cad800b33a6073d9377") -- capture2dworld
  and (name == "capture2dworld")
  and (msg == 1) then
    process_message(text)
  end
end


function process_message(text)
  local t = utils.split(text, "Ø")

  local fgcol = t[1]
  local bgcol = t[2]
  local txt = t[3]

  if (txt == "\r\n") and (add_blanks) then
    add_to_mini("silver", "", " ")
  end

  add_to_mini(fgcol, bgcol, txt)
end


function add_to_mini(fgcol, bgcol, txt)
  if (show_mini) then
    if (not styles) then
      styles = {}
    end

    if (txt == "\r\n") then
      log_to_mini("", "", "", styles)
      styles = {}

    else
      styles[#styles + 1] = {
        text = txt,
        textcolour = ColourNameToRGB(fgcol),
        backcolour = ColourNameToRGB(bgcol),
        length = string.len(txt),
        style = 0,
      }
    end
  end
end


]]>

</script>

</muclient>
