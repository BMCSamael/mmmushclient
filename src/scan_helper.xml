<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Wednesday, July 31, 2013, 8:49 AM -->
<!-- MuClient version 4.90 -->

<!-- Plugin "scan_helper" generated by Plugin Wizard -->

<muclient>

<plugin
   name="scan_helper"
   author="Ruthgul"
   id="697bd90f4f6ee5ac1493050c"
   language="Lua"
   purpose="subtitles + highlights for scan output"
   date_written="2013-07-31 08:47:07"
   date_modified="2014-01-26 03:19:22"
   requires="4.71"
   version="1.0"
   >

<description trim="y">

<![CDATA[

.---------------.
 | scan_helper |
`---------------'

Edits the output of the scan command:
- gags empty directions;
- adds subtitles for distances (number of rooms);
- lets you add highlights.


Syntax:

* scan add highlight <name>  - adds a name to the list of highlights
* scan del highlight <name>  - removes a name from the list of highlights
* scan del highlights  - removes all names from the list of highlights

* scan add special highlight <name>  - adds a special highlight (there can be only one)
* scan del special highlight  - removes the special highlight

* scan list highlights  - shows a list of all the current highlights


Edit the variables highlight_color and special_highlight_color to change the colors used for highlights.


Author: Ruthgul

Latest version:
http://github.com/MateriaMagicaLLC/mm-mushclient-scripts

]]>

</description>

</plugin>



<!--  Variables  -->

<variables>

<!-- edit these variables to change the highlights colors -->
  <variable name="highlight_color">tomato</variable>
  <variable name="special_highlight_color">springgreen</variable>

<!-- do not touch this variable -->
  <variable name="char_name">[a-zA-Z0-9 \-\,\.\']+</variable>

</variables>



<!--  Aliases  -->

<aliases>

  <alias
   enabled="y"
   match="^scan[ ]+add[ ]+highlight[ ]+(?P&lt;what&gt;.+)$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>add_highlight("%&lt;what&gt;")
</send>
  </alias>

  <alias
   enabled="y"
   match="^scan[ ]+del[ ]+highlight[ ]+(?P&lt;what&gt;.+)$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>del_highlight("%&lt;what&gt;")
</send>
  </alias>

  <alias
   enabled="y"
   match="^scan[ ]+del[ ]+highlights$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>del_highlights()
</send>
  </alias>

  <alias
   enabled="y"
   match="^scan[ ]+add[ ]+special[ ]+highlight[ ]+(?P&lt;what&gt;.+)$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>add_special_highlight("%&lt;what&gt;")
</send>
  </alias>

  <alias
   enabled="y"
   match="^scan[ ]+list[ ]+highlights$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>list_highlights()
</send>
  </alias>


<!--  Plugin help  -->

  <alias
   enabled="y"
   match="^scan\_helper(|( |\:)help)$"
   regexp="y"
   script="OnHelp"
  >
  </alias>

</aliases>



<!--  Triggers -->

<triggers>

<!-- gag empty directions -->

  <trigger
   enabled="y"
   keep_evaluating="y"
   match="^You don\'t see anything (to the (.+)|upwards|downwards)\.$"
   omit_from_output="y"
   regexp="y"
   sequence="100"
  >
  </trigger>


<!-- non-empty line -->

  <trigger
   enabled="y"
   expand_variables="y"
   match="^(|\* )(@!char_name) (|\[Player\] )(|is )(?P&lt;desc&gt;(right here|close by|not far off|a brief walk away|rather far off|in the distance|almost out of sight)) (?P&lt;dir&gt;(to the (.+)|upwards|downwards))\.$"
   omit_from_output="y"
   regexp="y"
   send_to="14"
   sequence="100"
  >
  <send>trigger_style_runs = TriggerStyleRuns
subtitle_scan("%&lt;desc&gt;", "%&lt;dir&gt;")
</send>
  </trigger>

</triggers>



<!--  Scripts  -->

<script>

<![CDATA[

require "serialize"


-----------------
-- plugin stuff
-----------------

function OnPluginInstall()
  Tell("-- " .. GetPluginInfo(GetPluginID(), 1) .. ": type ")
  ColourTell("silver", "black", GetPluginInfo(GetPluginID(), 1) .. " help")
  Note(" to see info about this plugin --")

  init_highlights()
end


function OnHelp()
  ColourNote("silver", "black", world.GetPluginInfo(world.GetPluginID(), 3))
  Note("")
  ColourNote("silver", "black", "(this version: " .. os.date("%c", GetPluginInfo(GetPluginID(), 14)) .. ")")
end


function plugin_update_url()
  local t = {
    "https://raw.githubusercontent.com/MateriaMagicaLLC/mm-mushclient-scripts/master/src/scan_helper.xml",
  }
  return (table.concat(t, ","))
end



------------------
-- general stuff
------------------

function find_index(t, item)
  local res = nil

  for i = 1, #t do
    if (t[i] == item) then
      res = i
      break
    end
  end

  return res
end



---------------------
-- highlights stuff
---------------------

function init_highlights()
  highlights = {}
  special_highlight = nil
end


function add_highlight(what)
  what = Trim(string.lower(what))

  Tell("-- scan_helper - '")
  ColourTell("silver", "black", what)

  if (not find_index(highlights, what)) then
    highlights[#highlights + 1] = what
    Note("' added to my list of highlights --")

  else
    Note("' is already in my list of highlights --")
  end

  table.sort(highlights)
end


function del_highlight(what)
  what = Trim(string.lower(what))

  Tell("-- scan_helper - '")
  ColourTell("silver", "black", what)

  local index = find_index(highlights, what)

  if (index) then
    table.remove(highlights, index)
    Note("' removed from my list of highlights --")

  else
    Note("' is NOT in my list of highlights --")
  end
end


function add_special_highlight(what)
  what = Trim(string.lower(what))

  special_highlight = what

  Tell("-- scan_helper - '")
  ColourTell("silver", "black", what)
  Note("' added as a special highlight --")
end


function del_highlights()
  highlights = {}
  Tell("-- scan_helper - all highlights removed!")
end


function del_special_highlights()
  special_highlight = nil
  Tell("-- scan_helper - special highlight removed!")
end


function list_highlights()
  Note("-- scan_helper - current highlights --")
  Tell("regular: ")
  Note(serialize.save_simple(highlights))

  if (special_highlight) then
    Note("special: " .. special_highlight)
  end
end


function is_in_highlights(what)
  local res = nil

  for i = 1, #highlights do
    if (string.find(what, highlights[i])) then
      res = i
      break
    end
  end

  return res
end



-----------------------
-- distance subtitles
-----------------------

scan_dist = {
  ["right here"] = "1",
  ["close by"] = "2",
  ["not far off"] = "3",
  ["a brief walk away"] = "4",
  ["rather far off"] = "5",
  ["in the distance"] = "6",
  ["almost out of sight"] = "7"
}


function subtitle_scan(desc, dir)
  local fgcol, txt

  for k, v in ipairs(trigger_style_runs) do
    -- highlight?
    if ((special_highlight)
    and (string.find(string.lower(v.text), special_highlight))) then
      fgcol = GetVariable("special_highlight_color")
    elseif (is_in_highlights(string.lower(v.text))) then
      fgcol = GetVariable("highlight_color")
    else
      fgcol = RGBColourToName(v.textcolour)
    end

    -- add subtitle for distance, if applicable
    txt = string.gsub(v.text, desc, desc .. "[" .. scan_dist[desc] .. "]")

    -- show the line
    ColourTell(fgcol,
               RGBColourToName(v.backcolour),
               txt)
  end

  Note("")
end


]]>

</script>

</muclient>
