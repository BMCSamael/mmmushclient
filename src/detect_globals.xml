<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Thursday, June 20, 2013, 8:13 AM -->
<!-- MuClient version 4.90 -->

<!-- Plugin "detect_globals" generated by Plugin Wizard -->


<!-- Notes for developers:

* use get_global_var() to read the values - it's a function in the global_vars plugin, so you'll need to use CallPlugin() to call it, like this:

my_name = get_global_var("name")
my_race = get_global_var("race")

(... etc.)

where:

function get_global_var(name)
  local res, val

  res, val = CallPlugin("97784abf5f30629a0d7e7307", "get_global_var", name)

  if (res ~= 0) then
    val = nil
  end

  return val
end


* to detect this plugin's broadcasts from another plugin:

function OnPluginBroadcast(msg, id, pname, text)
  if (id =="97784abf5f30629a0d7e7307")
  and (pname == "global_vars") then
    if (msg == 1) and (text == "name") then
      name = get_global_var("name")

      (... then do whatever else you need to do on name detection)
    end
  end
end


* if your script needs it to keep track of your current weapon, like combat stat does, you need to notify it by setting a detect_weapon variable to "true", via a call to global vars, like this:


set_global_var("detect_weapon", "true")


where:


function set_global_var(name, value)
  local res, val, done

  res, val = CallPlugin("97784abf5f30629a0d7e7307", "set_global_var", name, value)

  done = (res == 0)

  return done
end

-->


<muclient>

<plugin
   name="detect_globals"
   author="Ruthgul"
   id="d900cb999816b1f6f2d4bdc5"
   language="Lua"
   purpose="detect stuff that is relevant to other plugins"
   date_written="2013-06-20 08:11:54"
   date_modified="2017-07-28 22:42:57"
   requires="4.71"
   version="1.0"
   sequence="300"
   >

<description trim="y">

<![CDATA[

.------------------.
 | detect_globals |
`------------------'

Detects & keeps track of stuff that is relevant to several other plugins.

It currently keeps track of name, race, class path, and current weapon.


** REQUIRES **

- MM_GMCP_Handler (plugin id="f67c4339ed0591a5b010d05b") must be installed and enabled.
- global_vars (plugin id="97784abf5f30629a0d7e7307") must be installed and enabled.


Author: Ruthgul

Latest version:
http://github.com/MateriaMagicaLLC/mm-mushclient-scripts

]]>

</description>

</plugin>



<!--  Variables  -->

<variables>

  <variable name="char_name">[a-zA-Z0-9 \-\,\.\']+</variable>

</variables>



<!--  Aliases  -->

<aliases>

<!--  Plugin help  -->

  <alias
   enabled="y"
   match="^detect\_globals(|( |\:)help)$"
   regexp="y"
   script="OnHelp"
  >
  </alias>

</aliases>


<!--  Triggers  -->

<triggers>

<!-- on game version -->

  <trigger
   enabled="y"
   match="^           \`\|   \|\' \|\; \| \`\|\_\_\| \|\|  \\\_\,  \|\; \|  v(?P&lt;version&gt;.+)$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>on_game_version("%&lt;version&gt;")</send>
  </trigger>

<!-- on first prompt -->

  <trigger
   enabled="y"
   name="first_prompt"
   keep_evaluating="y"
   match="^(|[^ ]+(.*?))(\&lt;(.+)hp (.+)sp (.+)st\&gt;|\(.+\)|\&gt;) $"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>on_first_prompt()
</send>
  </trigger>


<!-- here on multiclass or respec -->

  <trigger
   enabled="y"
   keep_evaluating="y"
   match="^You are surrounded by a glowing aura of silver light\!$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>detect_char_base()
</send>
  </trigger>


<!-- here on archon -->

  <trigger
   enabled="y"
   keep_evaluating="y"
   match="^You begin glowing with a bright magenta light\, and feel previously unknown knowledge and wisdom entering your form\!$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>detect_char_base()
</send>
  </trigger>


<!-- detect weapon -->

  <trigger
   group="weapon_detection"
   keep_evaluating="y"
   match="^You wield (.+) in your (left|right) hand\.$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>do_detect_weapon()
</send>
  </trigger>

  <trigger
   group="weapon_detection"
   keep_evaluating="y"
   match="^You stop using (?P&lt;what&gt;.+)\.$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>check_if_removed_weapon("%&lt;what&gt;")
</send>
  </trigger>

  <trigger
   name="weapon_dmg"
   keep_evaluating="y"
   match="^With your knowledge of \'(?P&lt;type&gt;.+)\'\, (you may|(?P&lt;name&gt;.+) can) cause up to (.+) points of damage(.*?) against 0 ar\.$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>set_weapon("%&lt;type&gt;", "%&lt;name&gt;")
</send>
  </trigger>

  <trigger
   group="weapon_detection"
   keep_evaluating="y"
   expand_variables="y"
   match="^(@!char_name) knocks (.+) from your grip(|\, and (.+) falls clattering to the ground)\.$"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>set_weapon("hand to hand", "")
</send>
  </trigger>

</triggers>



<!--  Scripts  -->

<script>

<![CDATA[

require "wait"
require "gmcphelper"

game_version = ""


-----------------
-- plugin stuff
-----------------

function OnPluginInstall()
  Tell("-- " .. GetPluginInfo(GetPluginID(), 1) .. ": type ")
  ColourTell("silver", "black", GetPluginInfo(GetPluginID (), 1) .. " help")
  Note(" to see info about this plugin --")


  init_stuff()
end


function OnPluginConnect()
  init_stuff()
end


function OnHelp()
  ColourNote("silver", "black", world.GetPluginInfo(world.GetPluginID (), 3))
  Note("")
  ColourNote("silver", "black", "(this version: " .. os.date("%c", GetPluginInfo (GetPluginID(), 14)) .. ")")
end


function plugin_update_url()
  local t = {
    "https://raw.githubusercontent.com/MateriaMagicaLLC/mm-mushclient-scripts/master/src/detect_globals.xml",
  }
  return (table.concat(t, ";"))
end



------------------
-- generic stuff
------------------

function set_global_var(name, value)
  local res, val, done

  res, val = CallPlugin("97784abf5f30629a0d7e7307", "set_global_var", name, value)

  done = (res == 0)

  return done
end


function get_global_var(name)
  local res, val

  res, val = CallPlugin("97784abf5f30629a0d7e7307", "get_global_var", name)

  if (res ~= 0) then
    val = nil
  end

  return val
end



---------------
-- init stuff
---------------

function init_stuff()
  EnableTrigger("first_prompt", true)

  weapon = nil
end

function on_game_version(version)
  game_version = version
end

function send_id()
  if (game_version ~= "4.50") then
    SendNoEcho("protocol register MM_MUSHclient_bundle")
  end
end


--------------
-- GMCP base
--------------

function on_first_prompt()
  EnableTrigger("first_prompt", false)

  detect_char_base()
  send_id()
end


function detect_char_base()
  Execute("sendgmcp char.base")
end


function get_gmcp_char_base(name)
  local res, gmcparg = CallPlugin("f67c4339ed0591a5b010d05b", "gmcpval", "char.base")
  luastmt = "gmcpdata = " .. gmcparg

  assert(loadstring(luastmt or ""))()
end


function got_gmcp_char_base()
  local name = gmcpval("name")
--  Note(name)
  set_global_var("name", name)

  local race = gmcpval("race")
--  Note(race)
  set_global_var("race", race)

  local path, a_class

  for i = 1, 4 do
    a_class = gmcpval("class" .. i)
    if (a_class) then
      if (not path) then
        path = a_class
      else
        path = path .. "/" .. a_class
      end

    else
      break
    end
  end

  a_class = gmcpval("current-class")
  if (a_class == "archon") then
    path = path .. "/archon"
  end

--  Note(path)

  set_global_var("path", path)
end



---------------
-- broadcasts
---------------

function OnPluginBroadcast(msg, id, pname, txt)
  if (id == "f67c4339ed0591a5b010d05b")
  and (pname == "MM_GMCP_handler")
  and (txt == "char.base") then
    get_gmcp_char_base()
    got_gmcp_char_base()

  elseif (id =="97784abf5f30629a0d7e7307")
  and (pname == "global_vars") then
    if (msg == 1) and (txt == "detect_weapon") then
      detect_weapon = (get_global_var("detect_weapon") == "true")

      if (detect_weapon) then
        enable_weapon_detection()
      else
        disable_weapon_detection()
      end
    end
  end
end



-----------
-- weapon
-----------

function enable_weapon_detection()
  EnableTriggerGroup("weapon_detection", true)
  do_detect_weapon()
end


function disable_weapon_detection()
  EnableTriggerGroup("weapon_detection", false)
end


function check_if_removed_weapon(what)
  if (what == weapon.name) then
    set_weapon("hand to hand", "")
  end
end


function do_detect_weapon()
  Note("-- detect_globals: sending 'eq' to detect your weapon type --")
  EnableTrigger("weapon_dmg", true)
  Send("eq")
end


function set_weapon(wtype, wname)
  EnableTrigger("weapon_dmg", false)

  weapon = {
    type = wtype,
    name = wname,
  }

  set_global_var("weapon", wtype .. "/" .. wname)
end


]]>


</script>

</muclient>
