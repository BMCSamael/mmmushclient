<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Tuesday, June 19, 2012, 10:46 PM -->
<!-- MuClient version 4.81 -->

<!-- Plugin "quests_abridged" generated by Plugin Wizard -->

<muclient>

<plugin
   name="quests_abridged"
   author="Ruthgul"
   id="e377771aeee520a633f3dd4d"
   language="Lua"
   purpose="Implements abridged q s #, q c # - for multi-questing"
   save_state="y"
   date_written="2012-06-19 22:44:42"
   date_modified="2020-10-04 03:46:32"
   requires="4.71"
   version="1.0"
   >

<description trim="y">

<![CDATA[

.-------------------.
 | quests_abridged |
`-------------------'

Syntax:

* q s all  - checks your current quests and builds a table for abridged references

* q s [<num>]  - quest status for the last quest checked, or the quest that appears at location <num> in your quests list

* q c <num>  - creates an hyperlink to quest complete, for the quest that appears at location <num> in your quests list

* q Q <num>  - cancels the quest that appears at location <num> in your quest list

* q r  - quest request


Author: Ruthgul

Latest version:
http://github.com/MateriaMagicaLLC/mm-mushclient-scripts

]]>

</description>

</plugin>



<!--  Variables  -->

<variables>

  <variable name="buttons">salmon</variable>

</variables>



<!--  Aliases  -->

<aliases>

  <alias
   match="^q[ ]+s[ ]+all$"
   enabled="y"
   regexp="y"
   sequence="100"
   script="build_table_start"
  >
  </alias>

  <alias
   match="^q[ ]+s(|[ ]+(?<num>[0-9]+))$"
   enabled="y"
   group="quests_abridged"
   regexp="y"
   sequence="100"
   script="quest_status"
  >
  </alias>

  <alias
   match="^q[ ]+c[ ]+(?<num>[0-9]+)$"
   enabled="y"
   group="quests_abridged"
   regexp="y"
   sequence="100"
   script="quest_complete"
  >
  </alias>

  <alias
   match="^q[ ]+Q[ ]+(?<num>[0-9]+)$"
   enabled="y"
   group="quests_abridged"
   regexp="y"
   sequence="100"
   script="quest_cancel"
  >
  </alias>

  <alias
   match="^q[ ]+r$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>quest_request()
</send>
  </alias>


  <!--  Plugin help  -->

  <alias
   enabled="y"
   match="^quests\_abridged(|( |\:)help)$"
   regexp="y"
   script="OnHelp"
  >
  </alias>

</aliases>



<!--  Triggers  -->

<triggers>

  <trigger
   enabled="y"
   keep_evaluating="y"
   match="^(You ask (.+) for a quest\.|You inform (.+) you have completed your quest \'(.+)\'\.|You have run out of time for your quest\, \'(.+)\'\.|You are no longer on the quest\, \'(.+)\'\.)$"
   regexp="y"
   sequence="100"
   script="build_table_start"
  >
  </trigger>

  <trigger
   group="quests_abridged"
   keep_evaluating="y"
   match="^Quest \#(?<num>[0-9]+)\: (?<name>.+) \((?<cgoals>[0-9]+)\/(?<tgoals>[0-9]+) goal(|s) complete\)\.$"
   omit_from_output="y"
   regexp="y"
   sequence="100"
   script="on_quest_line"
  >
  </trigger>

  <trigger
   group="quests_abridged"
   keep_evaluating="y"
   match="^Type QUEST STATUS \<\#\> for complete information on that quest\.$"
   regexp="y"
   sequence="100"
   script="build_table_end"
  >
  </trigger>


<!-- detect current quest # -->

  <trigger
   enabled="y"
   keep_evaluating="y"
   match="^This quest \[(?<num>.+)\] is called \'(.+)\'\,$"
   regexp="y"
   sequence="100"
   script="set_current_quest_num"
  >
  </trigger>

  <trigger
   enabled="y"
   group="mapper"
   keep_evaluating="y"
   match="^You inform (.+) you have completed your quest \'(.+)\'\.$"
   omit_from_output="y"
   regexp="y"
   sequence="100"
   script="set_current_quest_num"
  >
  </trigger>

</triggers>



<!--  Scripts  -->

<script>

<![CDATA[

buttoncol = GetVariable("buttons")


-----------------
-- plugin stuff
-----------------

function OnPluginInstall()
  Tell("-- " .. GetPluginInfo(GetPluginID (), 1) .. ": type ")
  ColourTell("silver", "black", GetPluginInfo(GetPluginID (), 1) .. " help")
  Note(" to see info about this plugin --")
  tquests = {}
end


function OnHelp ()
  ColourNote("silver", "black", world.GetPluginInfo(world.GetPluginID (), 3))
  Note("")
  ColourNote("silver", "black", "(this version: " .. os.date("%c", GetPluginInfo (GetPluginID(), 14)) .. ")")
end


function plugin_update_url()
  local t = {
    "https://raw.githubusercontent.com/MateriaMagicaLLC/mm-mushclient-scripts/master/src/quests_abridged.xml",
  }
  return (table.concat(t, ";"))
end



--------------------
-- redrawing stuff
--------------------

function show_line(styles)
  ColourTell(buttoncol, "black", "[" .. #tquests + 1 .. "] ")

  for _, v in ipairs(styles) do
    ColourTell(RGBColourToName(v.textcolour), 
               RGBColourToName(v.backcolour),
               v.text)
  end

  Note("")
end



-----------------
-- tables stuff
-----------------

function build_table_start()
  tquests = {}
  EnableTriggerGroup("quests_abridged", true)
  Execute("q status")
end


function on_quest_line(name, line, wildcards, styles)
  local num = wildcards.num

  show_line(styles)
  build_table(num)
end


function build_table(num)
  tquests[#tquests + 1] = tonumber(num)
end


function build_table_end()
  EnableTriggerGroup("quests_abridged", false)
end



-----------------
-- quests stuff
-----------------

function quest_status(name, line, wildcards)
  local num = wildcards.num

  if (num) and (num ~= "") then
    num = tonumber(num)

    if (tquests[num]) then
      Send("q status " .. tquests[num])

    else -- we're possibly only doing 1 quest, so the table is empty?
      Note("-- quests_abridged: you're only in " .. #tquests .. " quests! - trying q s " .. num .. " instead --")
      Send("q status " .. num)
    end

  else
    do_quest_status_last()
  end
end


function quest_complete(name, line, wildcards)
  local num = tonumber(wildcards.num)
  
  local cmd
  if (tquests[num]) then
    cmd = "q complete " .. tquests[num]

  else
    Note("-- quests_abridged: you're only in " .. #tquests .. " quests! - trying q c " .. num .. " instead --")
    cmd = "q complete " .. num
  end

  Hyperlink(cmd, "[" .. cmd .. "]", "", buttoncol, "black", false)

  Note("")
  Note("-- quests_abridged: make sure that all phases are completed before you click the hyperlink --")
end


function quest_cancel(name, line, wildcards)
  local num = tonumber(wildcards.num)

  local cmd
  if (tquests[num]) then
    cmd = "quest complete " .. tquests[num]
    Hyperlink(cmd, "[" .. cmd .. "]", "", buttoncol, "black", false)
    Note("")
    Note("-- quests_abridged: make sure that all phases are completed before you click the hyperlink --")

  else
    Note("-- quests_abridged: you're only in " .. #tquests .. " quests! --")
  end
end


function quest_request()
  Send("q request")
end



------------------------
-- current quest stuff
------------------------

function set_current_quest_num(name, line, wildcards)
  local num = tonumber(wildcards.num)
  
  quest_num = num
end


function do_quest_status_last()
  if (quest_num) then
    Send("q s " .. quest_num)

  else
    Send("q s")
  end
end


]]>

</script>

</muclient>
