<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Sunday, July 31, 2011, 4:57 PM -->
<!-- MuClient version 4.61 -->

<!-- Plugin "CrystalLocator" generated by Plugin Wizard -->

<muclient>
<plugin
   name="CrystalLocator"
   author="Elbereth w/ Ruthgul's assistance"
   id="e8db9e0976d964b82332096b"
   language="Lua"
   date_written="2011-07-31 16:56:35"
   version="1.0"
   >
<description trim="y">
<![CDATA[
CrystalLocator - Automatically finds the co-ords of a crystal, and updates IMap if you have it.

]]>
</description>

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Triggers  -->

<triggers>
  <trigger
   enabled="y"
   group="crystallocator"
   keep_evaluating="y"
   match="Tadamir the guildsman gives you a tightly-rolled scroll."
   send_to="12"
   sequence="100"
  >
  <send>EnableTrigger("findcrystal", true)
  EnableTrigger("findrealcrystal", true)
  </send>
  </trigger>

  <trigger
   group="crystallocator"
   keep_evaluating="y"
   match="The map includes the coordinates of the displayed area: (.?)\, (.?)\."
   multi_line="y"
   lines_to_match="23"
   name="findsugcrystal"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>
    sugcrystalx = %1
    sugcrystaly = %2
    -- we check if iMap is installed + started
    local result, imap_started = CallPlugin("adc3a873d4e47348da7cb426", "IsStarted")
    if (result == 0) then -- it is installed
      if (imap_started == false) then
        -- it isn't started, so we start it
        Execute("imap start")
      end
      Execute("imap dest ".. sugcrystalx .. "," .. sugcrystaly)
	  Execute("imap desticon custom")
     end</send>
  </trigger>

  <trigger
   group="crystallocator"
   lines_to_match="24"
   keep_evaluating="y"
   match="near one corner\.\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n"
   multi_line="y"
   name="findrealcrystal"
   regexp="y"
   send_to="12"
   sequence="100"
  >
   <send>http = require "socket.http"
local mylines = "%1\\r\\n%2\\r\\n%3\\r\\n%4\\r\\n%5\\r\\n%6\\r\\n%7\\r\\n%8\\r\\n%9\\r\\n%&lt;10&gt;\\r\\n%&lt;11&gt;\\r\\n%&lt;12&gt;\\r\\n%&lt;13&gt;\\r\\n%&lt;14&gt;\\r\\n%&lt;15&gt;\\r\\n%&lt;16&gt;\\r\\n%&lt;17&gt;\\r\\n%&lt;18&gt;\\r\\n%&lt;19&gt;\\r\\n%&lt;20&gt;\\r\\n%&lt;21&gt;\\r\\n%&lt;22&gt;\\r\\n"
page, retcode, header = http.request("http://mmatlas.dune.net/find-crystal-guild-vi.pl","map=".. mylines)

if (retcode == 200) then
  cstart = string.find(page, "(", 0, true)

  if (cstart ~= nil) then
    cend = string.find(page, ")", 0, true)
    crystal = string.sub(page, cstart + 1, cend - 1)
    Note("Your crystal is located at ".. crystal)

    -- we check if iMap is installed + started
    local result, imap_started = CallPlugin("adc3a873d4e47348da7cb426", "IsStarted")
    if (result == 0) then -- it is installed
      if (imap_started == false) then
        -- it isn't started, so we start it
        Execute("imap start")
      end
      Execute("imap dest ".. crystal)
	  Execute("imap desticon custom")
     end

  else
    Note("MMAtlas: " .. page)
  end

else
  Note("error accessing MMAtlas - code: " .. retcode)
end
EnableTrigger("findrealcrystal", false)</send>
  </trigger>
  

  <trigger
   group="crystallocator"
   lines_to_match="23"
   keep_evaluating="y"
   match="It looks like this map depicts an area closest to .*\.(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n(.*?)\n"
   multi_line="y"
   name="findcrystal"
   regexp="y"
   send_to="12"
   sequence="100"
  >
 
  <send>http = require "socket.http"
local mylines = "%1\\r\\n%2\\r\\n%3\\r\\n%4\\r\\n%5\\r\\n%6\\r\\n%7\\r\\n%8\\r\\n%9\\r\\n%&lt;10&gt;\\r\\n%&lt;11&gt;\\r\\n%&lt;12&gt;\\r\\n%&lt;13&gt;\\r\\n%&lt;14&gt;\\r\\n%&lt;15&gt;\\r\\n%&lt;16&gt;\\r\\n%&lt;17&gt;\\r\\n%&lt;18&gt;\\r\\n%&lt;19&gt;\\r\\n%&lt;20&gt;\\r\\n%&lt;21&gt;\\r\\n%&lt;22&gt;"
page, retcode, header = http.request("http://mmatlas.dune.net/find-crystal-guild-vi.pl","map=".. mylines)
if (retcode == 200) then
  cstart = string.find(page, "(", 0, true)

  if (cstart ~= nil) then
    cend = string.find(page, ")", 0, true)
    crystal = string.sub(page, cstart + 1, cend - 1)
    Note("Your crystal is located at ".. crystal)

    -- we check if iMap is installed + started
    local result, imap_started = CallPlugin("adc3a873d4e47348da7cb426", "IsStarted")
    if (result == 0) then -- it is installed
      if (imap_started == false) then
        -- it isn't started, so we start it
        Execute("imap start")
      end
      Execute("imap dest ".. crystal)
	  Execute("imap desticon custom")
     end

  else
    Note("MMAtlas: " .. page)
  end

else
  Note("error accessing MMAtlas - code: " .. retcode)
end
EnableTrigger("findcrystal", false)</send>
  </trigger>

  <trigger
   enabled="y"
   group="crystallocator"
   keep_evaluating="y"
   match="You take a blood crystal."
   sequence="100"
   send_to="10"
  >
<send>imap dest off
</send>
</trigger>
  
<trigger
   enabled="y"
   group="crystallocator"
   keep_evaluating="y"
   match="You take a small crystal."
   send_to="10"
   sequence="100"
  >
<send>imap dest off
</send>
</trigger>

<trigger
   enabled="y"
   group="crystallocator"
   keep_evaluating="y"
   match="You take a genuinely novel thought."
   send_to="10"
   sequence="100"
  >
<send>imap dest off
</send>
</trigger>

</triggers>

<!--  Aliases  -->

<aliases>
  <alias
   match="^crystal last$"
   enabled="y"
   group="crystallocator"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>if (crystal ~= nil) then
 ColourNote("blue", "black", "\\r\\nYour last crystal was located at: ", "white", "black", crystal)
else
Note("Go buy a map first!")
end</send>
  </alias>
  <alias
   match="^crystal off$"
   enabled="y"
   group="crystallocator"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>EnableTrigger("findcrystal", false)
  EnableTrigger("findrealcrystal", false)</send>
  </alias>
  <alias
   match="^crystal on$"
   enabled="y"
   group="crystallocator"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>EnableTrigger("findcrystal", true)
  EnableTrigger("findrealcrystal", true)</send>
  </alias>
</aliases>

!--  Plugin help  -->

<aliases>
  <alias
   script="OnHelp"
   match="^(crystal(| help)|CrystalLocator\:help)$"
   regexp="y"
   enabled="y"
  >
  </alias>
</aliases>


<script>
<![CDATA[



function OnHelp ()
  world.Note (world.GetPluginInfo (world.GetPluginID (), 3))
  Note("")
  Note ("Type:")
  ColourNote ("blue", "black", "* ", "lightyellow", "black", "crystal on", "blue", "black", " - to start the locator")
  ColourNote ("blue", "black", "* ", "lightyellow", "black", "crystal off", "blue", "black", " - to turn off the locator (You shouldn't need to do this)")
  ColourNote ("blue", "black", "* ", "lightyellow", "black", "crystal last", "blue", "black", " - to display the co-ords of your last crystal")
end
]]>

</script>



</muclient>
